<web-component name="mic-wave">
	<template>
		<canvas $canvas width="375" height="150"></canvas>
		<h1>공항이 어딘지 알고싶어요.</h1>
	</template>
</web-component>


<script type="module">
class MicWave {
	init($) {
		console.log(this.$canvas);
	}

	start() {
		navigator.getUserMedia({audio: true}, (stream) => {
				this.start_microphone(stream);
			},
			function(e) {
				alert('Error capturing audio.');
			}
		);
	}

	start_microphone(stream) {
		let canvas = this.$canvas;
		let ctx = canvas.getContext("2d");

		let audioContext = new AudioContext();
		let microphone_stream = audioContext.createMediaStreamSource(stream);

		let analyser_node = audioContext.createAnalyser();
		analyser_node.smoothingTimeConstant = 0;
		analyser_node.fftSize = 2048;

		microphone_stream.connect(analyser_node);


		let array_freq_domain = new Uint8Array(2048);

		function draw() {
			requestAnimationFrame(draw);

			analyser_node.getByteTimeDomainData(array_freq_domain);
			ctx.clearRect(0, 0, canvas.width, canvas.height);

			let HEIGHT = canvas.height;
			let sliceWidth = 1;
			let x = 0;

			ctx.beginPath();
			ctx.lineWidth = 1;
			ctx.strokeStyle = "#555";

			for (let i = 0; i < canvas.width; i++) {

				let v = array_freq_domain[i] / 128.0;
				let y = v * HEIGHT / 2;

				if (i === 0) {
					ctx.moveTo(x, y);
				} else {
					ctx.lineTo(x, y);
				}

				x += sliceWidth;
			}

			ctx.stroke();
		}

		draw();
	}
}

module.component("mic-wave", function() {
	return MicWave.prototype;
});
</script>
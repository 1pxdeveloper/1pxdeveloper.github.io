<!doctype html>
<html>
<head>
	<meta charset="utf8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>mic</title>
	<link rel="stylesheet" href="style.css"/>
	<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/web-animations/2.3.1/web-animations.min.js"></script>-->
	<script src="../src/js/1px.js"></script>
	<!--<script type="module" src="./components/dialog.js"></script>-->
	<!--<script type="module" src="components/waitdots.js"></script>-->
	<script type="module" src="components/testdb.js"></script>
	<script type="module" src="components/ui-speech-to-text4.js"></script>
	<script type="module" src="components/ui-text-to-speech2.js"></script>

	<script type="module" src="components/animated-dialog.js"></script>

	<script type="module" src="components/micwave.js"></script>


	<script type="module" src="components/ui-script-editor.js"></script>


</head>
<body>

<main id="main">
	<content>
		<animated-dialog id="app"></animated-dialog>
		<ui-speech-to-text id="stt" style="margin: auto; height: auto; opacity: 0"></ui-speech-to-text>
	</content>
</main>


<ui-script-editor id="editor"></ui-script-editor>


<script type="module">
$module.require(["DB", "$timeout"], function(DB, $timeout) {

	function capitalize(str) {
		return str[0].toUpperCase() + str.slice(1);
	}

	let editor = document.getElementById("editor");
	document.onkeydown = function(e) {
		if (e.key === "Escape") {
			editor.hidden = !editor.hidden;
		}
	};


	///
	let missions;

	window.app = document.getElementById("app");
	let stt = document.getElementById("stt");

	let main = document.getElementById("main");
	main.onclick = function() {
		main.onclick = null;

		stage = 0;
		step = 0;
		level = 0;

		missions = editor.getData();
		if (!missions) {
			alert("미션 스크립트가 없습니다.");
			return;
		}

		console.log(missions);



		app.ask(`Okay. What you do you?`)

		.then(_ => {
			show_stt();

			stt.guide_text = `"Do you mind ~"`;
			stt.guide_text2 = `슬로프 레벨을 추천해달라고 말해보세요.`;
			return stt.listen([""]);
		})




	};


	function show_stt() {
		// stt.style.visibility = "visible";
		stt.style.opacity = 1;
	}

	function hide_stt() {
		// stt.style.visibility = "hidden";
		stt.style.opacity = 0;
	}

	let stage = 0;
	let step = 0;
	let level = 0;

	let voice = parseInt(Math.random() * 17);
	if (voice === 1) {
		voice = 2;
	}

	let prev_query = "";
	let current_stage;
	let current_step;


	function intro() {
		current_stage = missions.sections[stage].stage;
		current_step = current_stage[step];

		if (current_step.ask && !current_step.ask[level + 1]) {

			return app.ask(current_step.ask[level]).then(res => {
				show_stt();
				stt.guide_text = current_step.guide || "";

				return stt.listen(current_step.answer).then(res => {
					failLevelDown();
					return intro();
				});
			})
		}


		return app.ask(current_step.ask[level]).then(_ => {
			failLevelDown();
			return intro();
		});
	}

	function next() {

		current_stage = missions.sections[stage].stage;
		current_step = current_stage[step];

		if (current_step.ask.length === 0) {
			stage++;
			step = 0;
			level = 0;
			return next();
		}

		if (!(current_step.ask && current_step.ask[level])) {
			return;
		}

		app.ask(current_step.ask[level].replace(/__+/g, prev_query))

		.then(_ => {

			stt.guide_text = current_step.guide || "";

			if (current_step.answer) {
				show_stt();

				return stt.listen(current_step.answer).then(res => {
					hide_stt();

					let {query, transcript} = res;

					return app.speak(transcript).then(_ => {

						if (query) {
							stage++;
							step = 0;
							level = 0;
							prev_query = query;
							return next();
						}
						else {
							failLevelDown();
							return next();
						}

					});


				}).catch(err => {
					hide_stt();
					failLevelDown();

					return next();
				});
			}
		})

	}

	function failLevelDown() {
		if (current_step.ask[level + 1]) {
			level++;
		}
		else if (current_stage[step + 1] && current_stage[step + 1].ask[0]) {
			step++;
			level = 0;
		}
		else {

		}
	}

	function next2() {
		hide_stt();
		stt.guide_text = "커피 주문하기";

		let ment = DB[stage][0][level];
		if (query === "go") {
			query = "to go";
		}

		if (query && level === 0 && query !== "no" && query !== "yes" && query !== "ok" && query !== "okay") {
			ment = capitalize(query) + ". " + ment;
		}

		app.ask(ment, voice)
		.then(_ => {
			show_stt();

			if (DB[stage][0][level + 1]) {
				return stt.listen(DB[stage][1]).then(res => app.speak(res.transcript).then(_ => res.query))
			}
			else {
				return stt.listen(DB[stage][1]).then(res => app.speak(res.transcript).then(_ => res.query))
			}
		})

		.then(isok => {

			if (isok) {
				query = isok;

				stage++;
				level = 0;
			}
			else {
				if (DB[stage][0][level + 1]) {
					level++;
				}
				else {
					stage++;
					level = 0;
				}

				if (!DB[stage]) {
					return outro();
				}

			}

			return next();
		})

		.catch(err => {

			if (!DB[stage]) {
				return outro();
			}

			if (DB[stage][0][level + 1]) {
				level++;
			}

			return next();
		});

	}


	function outro() {

		app.ask("Great. You are finished first conversation. How's your feel?")

		.then(_ => app.ask("Learning this expression will help you improve your English."))

		.then(_ => app.ask("Repeat after me."))

		.then(_ => app.ask(`I would like black coffee. please.`))

		.then(_ => {
			show_stt();

			stt.guide_text = "I would like black coffee. please.";
			return stt.listen([""]);
		})

		.then(_ => {
			hide_stt();
			return app.ask("Perfect. Do not forget this expression.")
		})

		.then(_ => {
			return app.ask("That's all for today. See you next time.")
		});
	}
});


</script>

</body>
</html>
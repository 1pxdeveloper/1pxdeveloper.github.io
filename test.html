<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Title</title>
	<script>window.exports = window;</script>
	<script src="1px.js/observable.js"></script>
</head>
<body>


<button onclick="play()">play</button>
<button onclick="pause()">pause</button>
<button onclick="resume()">resume</button>


<script>


Observable.prototype.switchMap = function(callback) {
	return this.pipe(observer => {
		let subscription;

		return {
			next(value) {
				if (subscription) subscription.unsubscribe();
				let observable = callback(value);
				subscription = observable.subscribe(observer);
			},

			complete() {},
		}
	});
};


Observable.prototype.concatMap = function(callback) {

	return this.pipe(observer => {

		let queue = [];
		let running = false;
		let completed = false;
		let subscriptions = [];

		function doQueue() {
			if (running) return;

			let nextJob = queue.shift();
			if (nextJob) {
				return nextJob();
			}

			if (completed) {
				observer.complete();
			}
		}

		return {
			next(value) {
				queue.push(() => {
					running = true;

					let observable = callback(value);
					if (!(observable instanceof Observable)) {
						observable = Observable.of(value);
					}

					subscriptions.push(observable.subscribe(
						value => observer.next(value),
						err => observer.error(err),
						() => {
							running = false;
							doQueue();
						},
					));
				});

				doQueue();
			},

			complete() {
				completed = true;
			},

			finalize() {
				subscriptions.forEach(subscription => subscription.unsubscribe());
			},
		}
	})
};


let pause$ = new BehaviorSubject(false);

let o = Observable.of(1, 2, 3, 4, 5, 6, 7, 8).concatMap(value => {

	return pause$.switchMap(paused => {
		console.log("switchMap", paused);
		return paused ? Observable.NEVER : Observable.timeout(1000, value);
	});

});


let x = o.subscribe(v => {

	console.log("@@@@@", v);
});




</script>


</body>
</html>
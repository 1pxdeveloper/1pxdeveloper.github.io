<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Title</title>
	<script>window.exports = window;</script>
	<script src="1px.js/observable.js"></script>
</head>
<body>


<button onclick="play()">play</button>
<button onclick="pause()">pause</button>
<button onclick="resume()">resume</button>


<script>


Observable.prototype.switchMap = function(callback) {
	return this.pipe(observer => {
		let subscription;

		return {
			next(value) {
				if (subscription) subscription.unsubscribe();
				let observable = callback(value);
				subscription = observable.subscribe(observer);
			},

			complete() {}
		}
	});
};



Observable.prototype.concatMap = function(callback) {

	return this.pipe(observer => {

		let queue = [];
		let ing = false;
		let isCompleted = false;

		function doQueue() {
			if (ing) return;

			let fn = queue.shift();
			if (fn) {
				fn();
			}
			else {
				if (isCompleted) {
					observer.complete();
				}
			}
		}

		return {
			next(value) {
				queue.push(() => {
					ing = true;

					let observable = callback(value);
					if (!(observable instanceof Observable)) {
						observable = Observable.of(value);
					}

					observable.subscribe(
						value => observer.next(value),
						err => observer.error(err),
						() => {
							ing = false;
							doQueue();
						},
					);
				});

				doQueue();
			},

			complete() {
				isCompleted = true;
			},
		}
	});
};


let pause$ = new BehaviorSubject(false);

let o = Observable.of(1, 2, 3, 4, 5, 6, 7, 8).concatMap(v => {
	return pause$.switchMap(v => {
		console.log("switchMap", v);
		return v ? Observable.NEVER : Observable.timeout(1000, v);
	});
});


o.subscribe(v => {

	console.log("@@@@@", v);
});


</script>


</body>
</html>